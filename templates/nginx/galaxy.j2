map $http_upgrade $connection_upgrade {
        default upgrade;
        ''      close;
}

upstream galaxy {
	server {{ galaxy_config.gravity.gunicorn.bind }};

	# Or if you serve galaxy at a path like http(s)://fqdn/galaxy
	# Remember to set galaxy_url_prefix in the galaxy.yml file.
	# server {{ galaxy_config.gravity.gunicorn.bind }}:/galaxy;
}

server {
	# Listen on port 443
	listen        *:443 ssl default_server;
        listen [::]:443 default_server;
	# The virtualhost is our domain name
	# server_name   "{{ inventory_hostname }}";
        server_name  ~^((?<subdomain>.*)\.)flyingrabb\.it$;

	# Our log files will go to journalctl
	access_log  syslog:server=unix:/dev/log;
	error_log   syslog:server=unix:/dev/log;

	# The most important location block, by default all requests are sent to gunicorn
	# If you serve galaxy at a path like /galaxy, change that below (and all other locations!)

        location / {
                # This is the backend to send the requests to.
                if ($subdomain = "headscale")
                {
                        proxy_pass http://127.0.0.1:8080;
                }
                proxy_pass http://galaxy;

                proxy_set_header Host $http_host;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $scheme;
                proxy_set_header Upgrade $http_upgrade;
        }


	location ~* /rabbitmq/(.*) {
		rewrite ^/rabbitmq/(.*)$ /$1 break;
		proxy_pass http://127.0.0.1:15672;
		proxy_buffering                    off;
		proxy_set_header Host              $http_host;
		proxy_set_header X-Real-IP         $remote_addr;
		proxy_set_header X-Forwarded-For   $proxy_add_x_forwarded_for;
		proxy_set_header X-Forwarded-Proto $scheme;
	}
        location /metrics {
                if ($subdomain = "headscale")
                {
                        proxy_pass http://127.0.0.1:9090;
                }
                proxy_pass http://galaxy;

                proxy_set_header Host $http_host;
        }

        location /admin {
                proxy_pass http://127.0.0.1:5000/admin;
                proxy_http_version 1.1;
                proxy_set_header Host $host;
                proxy_buffering off;
                proxy_set_header X-Real-IP $remote_addr;
                proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
                auth_basic "Administrator's Area";
                auth_basic_user_file /etc/nginx/.htpasswd;
        }


	# serve visualization and interactive environment plugin static content
	location ~ ^/plugins/(?<plug_type>[^/]+?)/((?<vis_d>[^/_]*)_?)?(?<vis_name>[^/]*?)/static/(?<static_file>.*?)$ {
		alias {{ galaxy_server_dir }}/config/plugins/$plug_type/;
		try_files $vis_d/${vis_d}_${vis_name}/static/$static_file
		          $vis_d/static/$static_file =404;
	}

}
